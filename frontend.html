<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Job Search</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { margin-top: 30px; }
.checkbox-group { margin-bottom: 10px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
button { margin-top: 10px; }
.job-detail { border: 1px solid #aaa; padding: 10px; margin-top: 20px; }
textarea { width: 100%; height: 120px; margin-top: 5px; }
</style>
</head>
<body>

<h1>Job Search</h1>
<div>
    <h3>Add Job Filter (Headline)</h3>
    <input type="text" id="newFilterInput" placeholder="Enter filter word">
    <button id="addFilterBtn">Add Filter</button>
    <p id="filterMessage" style="color:green;"></p>
</div>

<div>
    <h3>Locations</h3>
    <div id="locations" class="checkbox-group"></div>
</div>

<div>
    <h3>Job Titles / Keywords</h3>
    <div id="jobTitles" class="checkbox-group"></div>
</div>

<div>
    <button id="searchBtn">Search Jobs</button>
</div>

<h2>Search Results</h2>
<table id="resultsTable">
    <thead>
        <tr>
            <th>Select</th>
            <th>Headline</th>
            <th>Employer</th>
            <th>Municipality</th>
            <th>Deadline</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button id="moveToReviewBtn">Move Selected to Review</button>

<h2>Review List</h2>
<table id="reviewTable">
    <thead>
        <tr>
            <th>Headline</th>
            <th>Employer</th>
            <th>Municipality</th>
            <th>Deadline</th>
            <th>View Job</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="jobDetailView" class="job-detail" style="display:none;">
    <h3><a id="detailHeadline" target="_blank" rel="noopener"></a></h3>
    <p><strong>Employer:</strong> <span id="detailEmployer"></span></p>
    <p><strong>Municipality:</strong> <span id="detailMunicipality"></span></p>
    <p><strong>Deadline:</strong> <span id="detailDeadline"></span></p>
    <p><strong>Description:</strong></p>
    <textarea id="detailDescription" readonly></textarea>
    <p><strong>AI Prompt:</strong></p>
    <textarea id="aiPrompt"></textarea>
    <button id="copyPromptBtn">Copy Prompt</button>
</div>

<script>
const regionsList = [
    "Dalarna", "Ostergotland", "Orebro", "Jonkoping", "Sodermanlan", "Vastmanland", "Gavleborg"
];

const jobTitlesList = [
    "ekonom", "ekonomi", "strateg", "verksamhetsutvecklare"
];

let searchResults = [];
let reviewList = [];

// Render checklists dynamically
function renderChecklists() {
    const locContainer = document.getElementById("locations");
    regionsList.forEach(region => {
        const id = `region_${region}`;
        locContainer.innerHTML += `
            <label><input type="checkbox" id="${id}" value="${region}" checked> ${region}</label>
        `;
    });

    const jobContainer = document.getElementById("jobTitles");
    jobTitlesList.forEach(title => {
        const id = `job_${title}`;
        jobContainer.innerHTML += `
            <label><input type="checkbox" id="${id}" value="${title}" checked> ${title}</label>
        `;
    });
}

// Collect selected regions
function getSelectedRegions() {
    return Array.from(document.querySelectorAll("#locations input[type=checkbox]:checked"))
                .map(cb => cb.value);
}

// Collect selected job titles / keywords
function getSelectedJobTitles() {
    return Array.from(document.querySelectorAll("#jobTitles input[type=checkbox]:checked"))
                .map(cb => cb.value);
}

// Render tables
function renderResults() {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";
    searchResults.forEach((job, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><input type="checkbox" data-index="${idx}"></td>
	    <td><a href="${job.webpage_url}" target="_blank" rel="noopener"> ${job.headline}</a></td>
            <td>${job.employer_name}</td>
            <td>${job.municipality}</td>
            <td>${job.application_deadline_simple}</td>
        `;
        tbody.appendChild(tr);
    });
}

function renderReview() {
    const tbody = document.querySelector("#reviewTable tbody");
    tbody.innerHTML = "";
    reviewList.forEach((job, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${job.headline}</td>
            <td>${job.employer_name}</td>
            <td>${job.municipality}</td>
            <td>${job.application_deadline_simple}</td>
            <td><button data-index="${idx}" class="viewJobBtn">View</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.querySelectorAll(".viewJobBtn").forEach(btn => {
        btn.addEventListener("click", () => {
            const idx = btn.dataset.index;
            showJobDetail(reviewList[idx]);
        });
    });
}

async function addJobFilter(value) {
    await fetch("http://localhost:3000/job-filters", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            value,
            field: "headline",
            type: "exclude"
        })
    });
}


async function loadPrompt(job, templateId) {
    const res = await fetch("http://localhost:3000/prompt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            job_id: job.id,
            prompt_template_id: templateId
        })
    });

    const data = await res.json();

    if (!data.ok) {
        alert("Failed to load prompt: " + data.message);
        return;
    }

    document.getElementById("aiPrompt").value = data.prompt;
}

async function showJobDetail(job) {
    document.getElementById("jobDetailView").style.display = "block";
    const headlineLink = document.getElementById("detailHeadline");
headlineLink.textContent = job.headline;
headlineLink.href = job.webpage_url;
    document.getElementById("detailEmployer").textContent = job.employer_name;
    document.getElementById("detailMunicipality").textContent = job.municipality;
    document.getElementById("detailDeadline").textContent = job.application_deadline_simple;
    document.getElementById("detailDescription").value = job.description || "";

try {
    const res = await fetch("http://localhost:3000/prompt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            job_id: job.id,
            prompt_template_id: 1   // ← se till att ID finns i DB
        })
    });

    const data = await res.json();
    document.getElementById("aiPrompt").value =
        data.ok ? data.prompt : "Failed to load prompt.";
} catch (err) {
    console.error("Prompt error:", err);
    document.getElementById("aiPrompt").value = "Failed to load prompt.";
}

}

// Initialize checklists
renderChecklists();

// Search button click
// Search button click
document.getElementById("searchBtn").addEventListener("click", async () => {
    const selectedRegions = getSelectedRegions();
    const selectedJobs = getSelectedJobTitles();

    const params = {
        region: selectedRegions.join(","),
        q: selectedJobs.map(j => `"${j}"`).join(" OR "),
        limit: 50,
        offset: 0
    };

    console.log("SEARCH PARAMS:", params); // debug

    try {
        const res = await fetch("http://localhost:3000/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(params)
        });

        const data = await res.json();
        console.log("BACKEND RESPONSE:", data); // debug

        if (!data.ok) {
            alert("Error: " + data.message);
            return;
        }

        searchResults = data.jobs;
        renderResults();
    } catch (err) {
        console.error("Error fetching jobs:", err);
        alert("Failed to fetch jobs.");
    }
});







    // Move selected jobs to review
document.getElementById("moveToReviewBtn").addEventListener("click", () => {
    const checkboxes = document.querySelectorAll("#resultsTable tbody input[type=checkbox]:checked");
    checkboxes.forEach(cb => {
        const idx = cb.dataset.index;
        const job = searchResults[idx];
        if (!reviewList.find(j => j.id === job.id)) reviewList.push(job);
    });
    renderReview();
});

// Copy AI prompt
document.getElementById("copyPromptBtn").addEventListener("click", () => {
    const promptBox = document.getElementById("aiPrompt");
    promptBox.select();
    document.execCommand("copy");
    alert("Prompt copied to clipboard!");
});


document.getElementById("addFilterBtn").addEventListener("click", async () => {
    const input = document.getElementById("newFilterInput");
    const value = input.value.trim();

    if (!value) {
        alert("Please enter a filter value.");
        return;
    }

    try {
        const res = await fetch("http://localhost:3000/job-filters", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                value,
                field: "headline",  // Du kan göra dynamiskt om du vill
                type: "exclude"
            })
        });

        const data = await res.json();
        const msg = document.getElementById("filterMessage");

        if (data.ok) {
            msg.textContent = `Filter "${value}" added successfully!`;
            input.value = "";
        } else {
            msg.textContent = `Error: ${data.message}`;
        }

        // Rensa meddelande efter några sekunder
        setTimeout(() => { msg.textContent = ""; }, 4000);

    } catch (err) {
        console.error("Error adding filter:", err);
        alert("Failed to add filter.");
    }
});

</script>

</body>
</html>

