<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Job Search</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h2 { margin-top: 30px; }
.checkbox-group { margin-bottom: 10px; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background-color: #f0f0f0; }
button { margin-top: 10px; }
.job-detail { border: 1px solid #aaa; padding: 10px; margin-top: 20px; }
textarea { width: 100%; height: 120px; margin-top: 5px; }
</style>
</head>
<body>

<h1>Job Search</h1>

<div>
    <h3>Locations</h3>
    <div id="locations" class="checkbox-group"></div>
</div>

<div>
    <h3>Job Titles / Keywords</h3>
    <div id="jobTitles" class="checkbox-group"></div>
</div>

<div>
    <button id="searchBtn">Search Jobs</button>
</div>

<div>
    <h3>Filters (exclude headline)</h3>
    <input type="text" id="newFilterInput" placeholder="Ex: bilplÃ¥tslagare">
    <button id="addFilterBtn">Add Filter</button>
    <ul id="filtersList"></ul>
</div>

<h2>Search Results</h2>
<table id="resultsTable">
    <thead>
        <tr>
            <th>Select</th>
            <th>Headline</th>
            <th>Employer</th>
            <th>Municipality</th>
            <th>Deadline</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button id="moveToReviewBtn">Move Selected to Review</button>

<h2>Review List</h2>
<table id="reviewTable">
    <thead>
        <tr>
            <th>Headline</th>
            <th>Employer</th>
            <th>Municipality</th>
            <th>Deadline</th>
            <th>View Job</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="jobDetailView" class="job-detail" style="display:none;">
    <h3><a id="detailHeadline" target="_blank" rel="noopener"></a></h3>
    <p><strong>Employer:</strong> <span id="detailEmployer"></span></p>
    <p><strong>Municipality:</strong> <span id="detailMunicipality"></span></p>
    <p><strong>Deadline:</strong> <span id="detailDeadline"></span></p>
    <p><strong>Description:</strong></p>
    <textarea id="detailDescription" readonly></textarea>
    <p><strong>AI Prompt:</strong></p>
    <textarea id="aiPrompt"></textarea>
    <button id="copyPromptBtn">Copy Prompt</button>
</div>

<script>
const regionsList = ["Dalarna","Ostergotland","Orebro","Jonkoping","Sodermanlan","Vastmanland","Gavleborg"];
const jobTitlesList = ["ekonom","ekonomi","strateg","verksamhetsutvecklare"];

let searchResults = [];
let reviewList = [];

// --- Render Checklists ---
function renderChecklists() {
    const locContainer = document.getElementById("locations");
    regionsList.forEach(region => {
        const id = `region_${region}`;
        locContainer.innerHTML += `<label><input type="checkbox" id="${id}" value="${region}" checked> ${region}</label>`;
    });

    const jobContainer = document.getElementById("jobTitles");
    jobTitlesList.forEach(title => {
        const id = `job_${title}`;
        jobContainer.innerHTML += `<label><input type="checkbox" id="${id}" value="${title}" checked> ${title}</label>`;
    });
}

// --- Selected Regions & Job Titles ---
function getSelectedRegions() {
    return Array.from(document.querySelectorAll("#locations input[type=checkbox]:checked")).map(cb => cb.value);
}
function getSelectedJobTitles() {
    return Array.from(document.querySelectorAll("#jobTitles input[type=checkbox]:checked")).map(cb => cb.value);
}

// --- Render Search Results ---
function renderResults(jobsToRender = searchResults) {
    const tbody = document.querySelector("#resultsTable tbody");
    tbody.innerHTML = "";
    jobsToRender.forEach((job, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td><input type="checkbox" data-index="${idx}"></td>
            <td><a href="${job.webpage_url}" target="_blank" rel="noopener">${job.headline}</a></td>
            <td>${job.employer_name}</td>
            <td>${job.municipality}</td>
            <td>${job.application_deadline_simple}</td>
        `;
        tbody.appendChild(tr);
    });
}

// --- Render Review ---
function renderReview() {
    const tbody = document.querySelector("#reviewTable tbody");
    tbody.innerHTML = "";
    reviewList.forEach((job, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${job.headline}</td>
            <td>${job.employer_name}</td>
            <td>${job.municipality}</td>
            <td>${job.application_deadline_simple}</td>
            <td><button data-index="${idx}" class="viewJobBtn">View</button></td>
        `;
        tbody.appendChild(tr);
    });

    document.querySelectorAll(".viewJobBtn").forEach(btn => {
        btn.addEventListener("click", () => showJobDetail(reviewList[btn.dataset.index]));
    });
}

// --- Filters ---
async function renderFilters() {
    const res = await fetch("http://localhost:3000/job-filters");
    const filters = await res.json();
    const list = document.getElementById("filtersList");
    list.innerHTML = "";
    filters.forEach(f => {
        if(f.type==="exclude" && f.field==="headline"){
            const li = document.createElement("li");
            li.textContent = f.value;
            list.appendChild(li);
        }
    });
}

async function addJobFilter(value){
    if(!value) return;
    await fetch("http://localhost:3000/job-filters", {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({value, field:"headline", type:"exclude"})
    });
    await renderFilters();
    applyFrontendFilters();
}

async function applyFrontendFilters(){
    const res = await fetch("http://localhost:3000/job-filters");
    const filters = await res.json();

    const filteredJobs = searchResults.filter(job => {
        for(const f of filters){
            if(f.type!=="exclude") continue;
            if(f.field==="headline" && job.headline.toLowerCase().includes(f.value.toLowerCase())){
                return false; // exkludera
            }
        }
        return true;
    });

    renderResults(filteredJobs);
}

// --- Job Detail ---
async function showJobDetail(job){
    document.getElementById("jobDetailView").style.display = "block";
    const headlineLink = document.getElementById("detailHeadline");
    headlineLink.textContent = job.headline;
    headlineLink.href = job.webpage_url;
    document.getElementById("detailEmployer").textContent = job.employer_name;
    document.getElementById("detailMunicipality").textContent = job.municipality;
    document.getElementById("detailDeadline").textContent = job.application_deadline_simple;
    document.getElementById("detailDescription").value = job.description || "";

    try{
        const res = await fetch("http://localhost:3000/prompt", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({job_id:job.id, prompt_template_id:1})
        });
        const data = await res.json();
        document.getElementById("aiPrompt").value = data.ok ? data.prompt : "Failed to load prompt.";
    }catch(err){
        console.error("Prompt error:", err);
        document.getElementById("aiPrompt").value = "Failed to load prompt.";
    }
}

// --- Copy Prompt ---
document.getElementById("copyPromptBtn").addEventListener("click", ()=>{
    const promptBox = document.getElementById("aiPrompt");
    promptBox.select();
    document.execCommand("copy");
    alert("Prompt copied!");
});

// --- Add Filter Button ---
document.getElementById("addFilterBtn").addEventListener("click", ()=>{
    const input = document.getElementById("newFilterInput");
    addJobFilter(input.value.trim());
    input.value = "";
});

// --- Search Button ---
document.getElementById("searchBtn").addEventListener("click", async ()=>{
    const params = {
        region: getSelectedRegions().join(","),
        q: getSelectedJobTitles().map(j=>`"${j}"`).join(" OR "),
        limit:50,
        offset:0
    };
    try{
        const res = await fetch("http://localhost:3000/search", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify(params)
        });
        const data = await res.json();
        searchResults = data.jobs;
        applyFrontendFilters(); // filtrera direkt
    }catch(err){
        console.error("Search error:", err);
        alert("Failed to fetch jobs");
    }
});

// --- Move to Review ---
document.getElementById("moveToReviewBtn").addEventListener("click", ()=>{
    const checkboxes = document.querySelectorAll("#resultsTable tbody input[type=checkbox]:checked");
    checkboxes.forEach(cb=>{
        const job = searchResults[cb.dataset.index];
        if(!reviewList.find(j=>j.id===job.id)) reviewList.push(job);
    });
    renderReview();
});

// --- Init ---
renderChecklists();
renderFilters();
</script>

</body>
</html>
